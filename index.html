<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
<link rel="stylesheet" type="text/css" href="main.css">
</head>
<body>
Your account <em id="accountAddress">Loading..</em>

    <div class="container">
<h1>defi domains</h1>
<h2 id="Domain"></h2>
<label for="name" class="col-lg-2 control-label">Domain Name</label>
        <input id="name" type="text">
<button id="button">query</button>
</div>
</br></br>
<label for="pricecheck" class="col-lg-2 control-label">Domain Name</label>
<input id="pricecheck" type="text">
<button id="pricecheckbtn">check price</button>
</br></br>
<label for="committer" class="col-lg-2 control-label">Purchase Name: Step 1 Commit:</label>
<input id="committer" type="text">
<button id="committerbtn">commit</button>
<br><br><br>
<b><u>Status:</b></u><br><br>
<p id="status"></p>
<span id="timer">
	<span id="time"></span>
</span>
<script type="module" crossorigin="anonymous">
    import { ethers } from "./ethers.esm.min.js";
	import { utils } from "./ethers.esm.min.js";
</script>
<script src="./ethers.umd.min.js" type="text/javascript">
</script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/ethjs@0.3.4/dist/ethjs.min.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
<script>
var el = function(id){ return document.querySelector(id); };
let provider;
window.ethereum.enable().then(provider = new ethers.providers.Web3Provider(window.ethereum));
const signer = provider.getSigner(0);		
$('#accountAddress').text(signer.getAddress(0));
  const tokenABI = [{"inputs":[{"internalType":"contract BaseRegistrar","name":"_base","type":"address"},{"internalType":"contract PriceOracle","name":"_prices","type":"address"},{"internalType":"uint256","name":"_minCommitmentAge","type":"uint256"},{"internalType":"uint256","name":"_maxCommitmentAge","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"name","type":"string"},{"indexed":true,"internalType":"bytes32","name":"label","type":"bytes32"},{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"cost","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"expires","type":"uint256"}],"name":"NameRegistered","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"name","type":"string"},{"indexed":true,"internalType":"bytes32","name":"label","type":"bytes32"},{"indexed":false,"internalType":"uint256","name":"cost","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"expires","type":"uint256"}],"name":"NameRenewed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oracle","type":"address"}],"name":"NewPriceOracle","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"constant":true,"inputs":[],"name":"MIN_REGISTRATION_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"string","name":"name","type":"string"}],"name":"available","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"bytes32","name":"commitment","type":"bytes32"}],"name":"commit","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"commitments","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"isOwner","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"internalType":"string","name":"name","type":"string"},{"internalType":"address","name":"owner","type":"address"},{"internalType":"bytes32","name":"secret","type":"bytes32"}],"name":"makeCommitment","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"payable":false,"stateMutability":"pure","type":"function"},{"constant":true,"inputs":[],"name":"maxCommitmentAge","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"minCommitmentAge","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"string","name":"name","type":"string"},{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint256","name":"duration","type":"uint256"},{"internalType":"bytes32","name":"secret","type":"bytes32"}],"name":"register","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"internalType":"string","name":"name","type":"string"},{"internalType":"uint256","name":"duration","type":"uint256"}],"name":"renew","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[],"name":"renounceOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"internalType":"string","name":"name","type":"string"},{"internalType":"uint256","name":"duration","type":"uint256"}],"name":"rentPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"internalType":"uint256","name":"_minCommitmentAge","type":"uint256"},{"internalType":"uint256","name":"_maxCommitmentAge","type":"uint256"}],"name":"setCommitmentAges","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"contract PriceOracle","name":"_prices","type":"address"}],"name":"setPriceOracle","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"internalType":"bytes4","name":"interfaceID","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"pure","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"internalType":"string","name":"name","type":"string"}],"name":"valid","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"withdraw","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}];
  
var address = '0x36593DA4b6E642339Ac37B64791430FE0c911173';
var contract = new ethers.Contract(address, tokenABI, provider);
var contractwrite = new ethers.Contract(address, tokenABI, signer);

$("#button").click(function() {
			var name = $("#name").val()
			contract.available(name).then((available) => {
			console.log(name, 'is', available);
		})});
		
$("#pricecheckbtn").click(function() {
			var name = $("#pricecheck").val()
			console.log(name);
			let currentPrice = contract.rentPrice(name,31536000).then((response) => {
				console.log(ethers.utils.formatEther(response, 'ether'));
			})});
			
$("#committerbtn").click(function() {
			console.log("started");
			var r = Math.random().toString(30).substring(10);
			var secret = ethers.utils.formatBytes32String(r);
			var commitname = $("#committer").val()
			var adr = signer.getAddress();
			console.log(commitname);
			console.log(secret);
			console.log(adr);
			let commits = contract.makeCommitment(commitname,adr,secret).then((response) => {
				var commited = response;
				console.log(commited);
				contractwrite.commit(commited);
				var counter = 90;
				var interval = setInterval(function() {
					counter--;
					// Display 'counter' wherever you want to display it.
					if (counter <= 0) {
						clearInterval(interval);
						$('#timer').html("<h3>Count down complete</h3>");  
						return;
					}else{
						$('#time').text('Waiting ' + counter +' more seconds before transaction part 2. The second transaction will load automatically when ready, and you\'ll be set to register your domain.');
						console.log("Timer " + counter);
						}
					}, 1000);
				let currentPrice = contract.rentPrice(commitname,31536000).then((response) => {
				var regPrice = ethers.utils.formatEther(response, 'ether');
				})
				let duration = 31536000;
				setTimeout(() => {
				contractwrite.register(regPrice,commitname,adr,duration,secret).then(tx => {
					console.log(tx);
						})
					}, 89000);
				}
			
			)
});
</script>
</body>
</html>